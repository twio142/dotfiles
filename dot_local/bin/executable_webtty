#!/bin/zsh

# Start a web terminal using ttyd and tunnel it via cloudflared.
# MODE=share to share the current tmux session.
# Additional arguments are passed to ttyd.

case $(background) in
  light) bg=white ;;
  *) bg=transparent ;;
esac

case $MODE in
  share) args=("$@" tmux attach -t "$(tmux display -p '#S')") ;;
  *)     args=(-W -m 1 -t enableTrzsz=true "$@" tmux) ;;
esac

set -m

ttyd -p 8167 -t 'fontFamily=NerdFont,FiraCode Nerd Font' -t fontSize=12 -t "theme={\"background\":\"$bg\"}" "${args[@]}" &
ttyd_pid=$!

cloudflared --config $XDG_CONFIG_HOME/cloudflared/config.yml tunnel run &
cf_pid=$!

trap 'kill $ttyd_pid $cloudflared_pid 2>/dev/null' EXIT INT TERM

wait $ttyd_pid $cloudflared_pid
