#!/bin/zsh

export PATH=$HOME/.local/bin:/opt/homebrew/opt/ruby/bin:$PATH:/opt/homebrew/bin
XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-~/.config}

case $1 in
  light|dark) mode=$1;;
  *)          exit 1 ;;
esac

# Nvim
fd 'nvim\.+|.+treemux.+' $TMPDIR -t s | while read -r socket; do
  if [[ $socket != *treemux* ]]; then
    pid=$(echo ${socket:t:r} | grep -oE '\d+')
    ps -p $pid &> /dev/null || continue
  fi
  python3 <<EOF
import pynvim
pynvim.attach('socket', path='$socket').command('set background=$mode')
EOF
done

# Tmux
[ $mode = light ] && flavor=latte || flavor=mocha
tmux set -g @catppuccin_flavor "$flavor"
tmux run-shell ${XDG_CONFIG_HOME}/tmux/plugins/tmux/catppuccin.tmux

# Alacritty theme
DIR=${XDG_CONFIG_HOME}/alacritty
if [ -f $DIR/$mode.toml ]; then
  ln -sf $DIR/$mode.toml $DIR/colors.toml
  touch $DIR/alacritty.toml
fi

# Hammerspoon
hs -A -c "ConsoleDM()"

# Marta theme
DIR=~/Library/Application\ Support/org.yanex.marta/Themes
if [ -f $DIR/$mode ]; then 
  ln -sf $DIR/$mode $DIR/T.theme
fi

# yazi theme
DIR=$XDG_CONFIG_HOME/yazi/themes
if [ -f $DIR/theme-$mode.yaml ]; then
  ln -sf $DIR/$mode.yaml $DIR/theme.yaml
fi

# lsd theme
DIR=$XDG_CONFIG_HOME/lsd
if [ -f $DIR/${mode}.yaml ]; then 
  ln -sf $DIR/${mode}.yaml $DIR/colors.yaml
fi

# Terminal theme
defaults write com.apple.Terminal 'Default Window Settings' "T ${mode:0:1:u}${mode:1}"
defaults write com.apple.Terminal 'Startup Window Settings' "T ${mode:0:1:u}${mode:1}"
