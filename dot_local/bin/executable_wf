#!/bin/zsh

info=${1:a}/info.plist
if [[ -f "$info" ]]; then
    cacheDir=~/Library/Caches/com.runningwithcrayons.Alfred/Workflow\ Data
    dataDir=~/Library/Application\ Support/Alfred/Workflow\ Data
    cd $1 &> /dev/null
    unset alfred_workflow_name
    unset alfred_workflow_uid
    unset alfred_workflow_bundleid
    unset alfred_workflow_cache
    unset alfred_workflow_data
    export alfred_workflow_name="$(defaults read $info name)"
    export alfred_workflow_uid=${1:t}
    export alfred_workflow_bundleid=$(defaults read $info bundleid)
    echo Workflow: $alfred_workflow_name
    [[ -z $alfred_workflow_bundleid ]] || {
        export alfred_workflow_cache=$cacheDir/$alfred_workflow_bundleid
        export alfred_workflow_data=$dataDir/$alfred_workflow_bundleid
    }
    if defaults read "$info" variables &> /dev/null; then
        while read -r l; do
            l=${l/%;}
            l=${l/ = /=}
            key=${l%%=*}
            value=${l#*=}
            [[ "$key" =~ ^\".*\"$ ]] && key="${key:1:-1}"
            [[ "$value" =~ ^\".*\"$ ]] && value="${value:1:-1}"
            [[ "$value" =~ ^\'.*\'$ ]] && value="${value:1:-1}"
            export "$key=$value" &> /dev/null
        done < <(defaults read "$info" variables 2> /dev/null | sed '1d;$d')
    fi
fi

prefs=${1:a}/prefs.plist
if [[ -f "$prefs" ]]; then
    if defaults read "$prefs" &> /dev/null; then
        while read -r l; do
            l=${l/%;}
            l=${l/ = /=}
            key=${l%%=*}
            value=${l#*=}
            [[ "$key" =~ ^\".*\"$ ]] && key="${key:1:-1}"
            [[ "$value" =~ ^\".*\"$ ]] && value="${value:1:-1}"
            [[ "$value" =~ ^\'.*\'$ ]] && value="${value:1:-1}"
            export "$key=$value" &> /dev/null
        done < <(defaults read "$prefs" 2> /dev/null | sed '1d;$d')
    fi
fi
