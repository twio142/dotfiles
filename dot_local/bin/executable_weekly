#!/bin/zsh

export TERM=xterm-256color
source ${XDG_CONFIG_HOME:-~/.config}/zsh/.zshrc &> /dev/null
cd &> /dev/null

# Upgrade homebrew packages
brew cu -a -y
brew update
brew cleanup
brew bundle dump --describe --force --file=${XDG_DATA_HOME:-~/.local/share}/chezmoi/bootstrap/Brewfile
brew upgrade

file_count=0
link_count=0
incomplete_count=0

# Clean up cask downloads
for cask_link in $(find ~/Library/Caches/Homebrew/Cask -type l)
do
    let file_count++
    trash "$(realpath $cask_link)"
    let link_count++
    rm $cask_link
done

# Clean up downloads
for link in $(find ~/Library/Caches/Homebrew -type l)
do
    let file_count++
    trash "$(realpath $link)"
    let link_count++
    rm $link
done

# Clean up incomplete downloads
incomplete_count=$(ls -l ~/Library/Caches/Homebrew/downloads/*.incomplete 2> /dev/null | wc -l)
[ $incomplete_count -gt 0 ] && rm ~/Library/Caches/Homebrew/downloads/*.incomplete

plural() {
    [ $1 -gt 1 ] && echo "$1 ${2}s" || echo "$1 $2"
}

echo "Pruned $(plural $link_count "symbolic link"), $(plural $file_count "file") and $(plural $incomplete_count "incomplete download") from ~/Library/Caches/Homebrew"

# Upgrade app store apps
mas upgrade

# Upgrade neovim plugins
nvim --headless '+Lazy! sync' +qa
nvim --headless '+MasonToolsUpdateSync' +qa

# Upgrade ProperTree
git -C ~/Projects/ProperTree pull
# Upgrade Rime
git -C ~/Library/Rime fetch --depth=1
~/Library/Rime/.git/hooks/post-fetch
# Upgrade zsh plugins
zimfw uninstall -q
zimfw upgrade
zimfw update
# Upgrade tmux plugins
$XDG_CONFIG_HOME/tmux/plugins/tpm/scripts/update_plugin_prompt_handler.sh all
tmux set -g status on &> /dev/null
# Upgrade yazi plugins
ya pkg upgrade
# Upgrade gh plugins
command -v gh &> /dev/null && gh extension upgrade --all
# Upgrade npm global packages
cmd=$(ncu -g -u | grep '^npm -g install') && eval $cmd || true

exec zsh
